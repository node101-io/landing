---
import { Image } from 'astro:assets';
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import isoBadge from '@/assets/images/iso-badge.webp';
import gdprBadge from '@/assets/images/gdpr.png';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const services = [
  {
    id: 'staking',
    label: t('services.staking'),
    description: t('services.staking.description'),
    spiral: '/img/services-spirals/staking-spiral.svg',
  },
  {
    id: 'rpc',
    label: t('services.rpc'),
    description: t('services.rpc.description'),
    spiral: '/img/services-spirals/rpc-spiral.svg',
  },
  {
    id: 'security',
    label: ['Security &', 'Compliance'],
    description: t('services.security.description'),
    spiral: '/img/services-spirals/security-spiral.svg',
  },
];
---

<section
  class={`
    m-0
    flex
    h-fit
    w-full
    flex-col
    overflow-hidden
    rounded-none
    bg-espresso
    lg:m-(--section-margin)
    lg:aspect-20/9
    lg:w-[calc(100%-var(--section-margin)*2)]
    lg:flex-row
    lg:rounded-4xl
  `}
  aria-label="Services"
>
  <!-- Left Side: Title and Clickable Labels -->
  <div class={`
    flex
    flex-col
    items-center
    justify-between
    p-6
    lg:w-1/2
    lg:items-start
    lg:p-10
  `}>
    <h2 class={`
      mt-8
      mb-6
      font-sans
      text-base
      font-normal
      text-cream
      sm:text-lg
      md:text-xl
      lg:mt-[3vw]
      lg:mb-0
      lg:text-[1.5vw]
    `}>
      {t('services.title')}
    </h2>

    <div class={`
      flex
      flex-row
      flex-wrap
      justify-center
      gap-2
      pb-4
      lg:flex-col
      lg:flex-nowrap
      lg:justify-start
      lg:gap-6
      lg:pb-0
    `}>
      {services.map((service, index) => (
        <div class="group relative">
          <input
            type="radio"
            name="service-selector"
            id={`service-${service.id}`}
            value={service.id}
            checked={index === 1}
            class={`
              peer
              sr-only
            `}
          />
          <label
            for={`service-${service.id}`}
            class={`
              relative
              block
              shrink-0
              cursor-pointer
              rounded-full
              bg-cream
              px-3
              py-1.5
              font-sans
              text-xs
              font-normal
              whitespace-nowrap
              text-espresso
              transition-all
              duration-500
              peer-checked:bg-lav-active
              peer-focus-visible:outline-2
              peer-focus-visible:outline-offset-4
              peer-focus-visible:outline-lav-active
              motion-reduce:transition-none
              sm:text-sm
              md:text-base
              lg:rounded-none
              lg:bg-transparent
              lg:px-0
              lg:py-0
              lg:pl-0
              lg:text-[4vw]
              lg:leading-none
              lg:whitespace-normal
              lg:text-cream
              lg:peer-checked:bg-transparent
              lg:peer-checked:pl-[1.5vw]
              lg:peer-checked:text-lav-active
            `}
          >
            <!-- Star Icon (desktop only) -->
            <img
              src="/img/star.svg"
              alt=""
              aria-hidden="true"
              class={`
                absolute
                top-[0.15em]
                left-0
                hidden
                size-[0.25em]
                scale-50
                opacity-0
                transition-all
                duration-500
                motion-reduce:transition-none
                lg:block
                lg:group-has-[:checked]:opacity-100
                lg:group-has-[:checked]:scale-100
              `}
            />
            {Array.isArray(service.label)
              ? service.label.map((line, i) => <>{i > 0 && <><span class={`
                lg:hidden
              `}>{' '}</span><br class={`
                hidden
                lg:inline
              `} /></>}{line}</>)
              : service.label}
          </label>
        </div>
      ))}
    </div>
  </div>

  <!-- Right Side: Sliding Cards -->
  <div class={`
    relative
    flex-1
    lg:w-1/2
    lg:pr-10
    lg:pl-4
  `}>
    <!-- Top gradient (desktop only) -->
    <div class={`
      pointer-events-none
      absolute
      inset-x-0
      top-0
      z-10
      hidden
      h-[14dvh]
      bg-linear-to-b
      from-espresso
      to-transparent
      lg:block
    `}></div>
    <!-- Bottom gradient (desktop only) -->
    <div class={`
      pointer-events-none
      absolute
      inset-x-0
      bottom-0
      z-10
      hidden
      h-[14dvh]
      bg-linear-to-t
      from-espresso
      to-transparent
      lg:block
    `}></div>
    <div class={`
      relative
      mb-[4vw]
      h-[65vw]
      sm:mb-6
      sm:h-72
      lg:mb-0
      lg:h-full
    `} id="services-cards-container">
      {services.map((service, index) => (
        <div
          class={`
            services-card
            absolute
            flex
            aspect-7/5
            w-[85vw]
            flex-col
            justify-between
            rounded-xl
            bg-cream
            p-[4vw]
            transition-[left,top,background-color]
            duration-600
            ease-[cubic-bezier(0.22,1,0.36,1)]
            motion-reduce:duration-0
            sm:w-96
            sm:p-5
            lg:aspect-auto
            lg:inset-x-0
            lg:h-[65%]
            lg:w-auto
            lg:justify-end
          `}
          data-service={service.id}
          data-index={index}
        >
          <!-- Mobile Header: spiral + title -->
          <div class={`
            mb-auto
            flex
            items-center
            justify-between
            lg:hidden
          `}>
            <img
              src={service.spiral}
              alt=""
              aria-hidden="true"
              class={`
                h-[6vw]
                w-auto
                sm:h-6
                lg:h-8
              `}
            />
            <h3 class={`
              text-right
              font-sans
              text-[5vw]
              tracking-wide
              text-espresso
              uppercase
              sm:text-lg
              lg:text-xl
            `}>
              {Array.isArray(service.label) ? service.label.join(' ') : service.label}
            </h3>
          </div>

          <!-- Desktop spiral (top right) -->
          <img
            src={service.spiral}
            alt=""
            aria-hidden="true"
            class={`
              absolute
              top-[1vw]
              right-[1vw]
              hidden
              h-[4vw]
              w-auto
              lg:block
            `}
          />

          <!-- Badges (security only) -->
          {service.id === 'security' && (
            <div class={`
              flex
              items-center
              gap-[1.5vw]
              sm:gap-2
              lg:absolute
              lg:top-[1vw]
              lg:left-[1vw]
              lg:gap-[0.5vw]
            `}>
              <Image src={isoBadge} alt="ISO 27001" class={`
                h-[6vw]
                w-auto
                sm:h-6
                lg:h-[2.5vw]
              `} />
              <Image src={gdprBadge} alt="GDPR" class={`
                h-[6vw]
                w-auto
                sm:h-6
                lg:h-[2.5vw]
              `} />
            </div>
          )}

          <!-- Description -->
          <p class={`
            py-[2vw]
            font-sans
            text-[3.5vw]
            leading-relaxed
            font-normal
            text-espresso
            sm:py-3
            sm:text-sm
            lg:py-0
            lg:text-[1.6vw]
          `}>
            {service.description}
          </p>

          <!-- Discover button (mobile only) -->
          <a
            href="#"
            class={`
              flex
              items-center
              justify-between
              rounded-full
              bg-espresso
              px-[3vw]
              py-[2vw]
              text-[2.5vw]
              text-cream
              transition-colors
              hover:bg-espresso/90
              sm:px-4
              sm:py-2.5
              sm:text-sm
              lg:hidden
            `}
          >
            <span>Discover</span>
            <img src="/img/arrow/arrow-right-light.svg" alt="" aria-hidden="true" class={`
              h-[2vw]
              w-auto
              sm:h-3
            `} />
          </a>
        </div>
      ))}
    </div>
  </div>
</section>

<script>
  function initServicesSection() {
    const radios = document.querySelectorAll<HTMLInputElement>('input[name="service-selector"]');
    const cards = document.querySelectorAll<HTMLElement>('.services-card');
    const serviceOrder = ['staking', 'rpc', 'security'];

    const CARD_HEIGHT = 65; // percentage
    const CENTER_POSITION = 17.5; // percentage from top
    const GAP = 4; // percentage gap between cards
    const OFFSET = CARD_HEIGHT + GAP; // 69%

    function updateCards(selectedId: string) {
      const selectedIndex = serviceOrder.indexOf(selectedId);
      const isMobile = window.innerWidth < 1024; // lg breakpoint

      cards.forEach((card) => {
        const cardService = card.dataset.service;
        if (!cardService) return;

        const cardIndex = serviceOrder.indexOf(cardService);
        const relativeIndex = cardIndex - selectedIndex;
        const zIndex = relativeIndex === 0 ? 3 : 2;

        if (isMobile) {
          // Mobile: horizontal slide
          const isSmall = window.innerWidth < 640; // sm breakpoint

          if (isSmall) {
            // Small screens: vw based
            const viewportWidth = window.innerWidth;
            const CARD_WIDTH = viewportWidth * 0.85;
            const GAP = viewportWidth * 0.02; // 2vw
            const centerLeft = (viewportWidth - CARD_WIDTH) / 2;
            const leftPosition = centerLeft + (relativeIndex * (CARD_WIDTH + GAP));
            card.style.left = `${leftPosition}px`;
          } else {
            // sm-lg: fixed card size, centered with gap
            const CARD_WIDTH_PX = 384;
            const GAP_PX = 24;
            const containerWidth = card.parentElement?.offsetWidth || window.innerWidth;
            const centerLeftPx = (containerWidth - CARD_WIDTH_PX) / 2;
            const leftPosition = centerLeftPx + (relativeIndex * (CARD_WIDTH_PX + GAP_PX));
            card.style.left = `${leftPosition}px`;
          }
          card.style.top = '50%';
          card.style.transform = 'translateY(-50%)';
          card.style.zIndex = String(zIndex);

          // Mobile: selected card has lav-active background
          if (cardService === selectedId) {
            card.classList.remove('bg-cream');
            card.classList.add('bg-lav-active');
          } else {
            card.classList.remove('bg-lav-active');
            card.classList.add('bg-cream');
          }
        } else {
          // Desktop: vertical slide
          const topPosition = CENTER_POSITION + (relativeIndex * OFFSET);

          card.style.left = '';
          card.style.top = `${topPosition}%`;
          card.style.transform = '';
          card.style.zIndex = String(zIndex);

          // Desktop: all cards have cream background
          card.classList.remove('bg-lav-active');
          card.classList.add('bg-cream');
        }
      });
    }

    radios.forEach((radio) => {
      radio.addEventListener('change', () => {
        if (radio.checked) {
          updateCards(radio.value);
        }
      });
    });

    // Handle resize - update cards when crossing breakpoints or on small screens
    let wasMobile = window.innerWidth < 1024;
    let wasSmall = window.innerWidth < 640;
    window.addEventListener('resize', () => {
      const isMobile = window.innerWidth < 1024;
      const isSmall = window.innerWidth < 640;
      // Update on breakpoint change OR always on mobile (viewport-dependent positioning)
      if (isMobile !== wasMobile || isSmall !== wasSmall || isMobile) {
        wasMobile = isMobile;
        wasSmall = isSmall;
        const checkedRadio = document.querySelector<HTMLInputElement>('input[name="service-selector"]:checked');
        if (checkedRadio) {
          updateCards(checkedRadio.value);
        }
      }
    });

    // Initialize
    const checkedRadio = document.querySelector<HTMLInputElement>('input[name="service-selector"]:checked');
    if (checkedRadio) {
      updateCards(checkedRadio.value);
    }
  }

  initServicesSection();
  document.addEventListener('astro:page-load', initServicesSection);
</script>


