---
import { getRelativeLocaleUrl } from 'astro:i18n';
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import Menu from './components/Menu.astro';
import MenuSection from './components/MenuSection.astro';
import NetworkGridIsland from './components/NetworkGridIsland.astro';
import { getMenuItems } from './menu-data';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const menuItems = getMenuItems(t);
---

<header class={`
  sticky
  top-(--header-margin)
  z-40
  mx-[calc(var(--header-margin)+var(--hero-margin))]
  mt-[calc(var(--header-margin)+var(--hero-margin))]
  mb-[calc((var(--header-margin)+var(--hero-margin))*-1-var(--header-height))]
  flex
  h-(--header-height)
  min-h-(--header-height)
  shrink-0
  items-center
  justify-center
  gap-8
  rounded-4xl
  bg-header-bg
  font-sans
  ring
  ring-surface
  backdrop-blur-md
  transition-[margin,border-radius,shadow,background-color,top]
  duration-300
  has-checked:top-0
  has-checked:mx-0
  has-checked:mt-0
  has-checked:mb-[calc(var(--header-height)*-1)]
  has-checked:rounded-none
  has-checked:bg-header-bg-checked
  has-checked:ring-header-bg-checked
  lg:has-checked:top-[calc(var(--header-margin)+var(--hero-margin))]
  lg:has-checked:mx-[calc(var(--header-margin)+var(--hero-margin))]
  lg:has-checked:mt-[calc(var(--header-margin)+var(--hero-margin))]
  lg:has-checked:mb-[calc((var(--header-margin)+var(--hero-margin))*-1-var(--header-height))]
  lg:has-checked:rounded-4xl
  lg:has-checked:bg-header-bg
  lg:has-checked:ring-surface
`}>
  <a href={getRelativeLocaleUrl(lang, '/')} class={`
    absolute
    left-4
    z-60
    flex
    h-full
    items-center
  `}>
    <img
      src="/img/logo.svg"
      alt="node101 logo"
      width="80"
      height="24"
      class={`
        h-auto
        w-20
        shrink-0
      `}
    />
  </a>

  {/* Mobile Menu Toggle - checkbox */}
  <input
    type="checkbox"
    id="mobile-menu-toggle"
    aria-label={t('nav.mobileMenuToggle')}
    class={`
      peer
      sr-only
    `}
  />

  {/* Navigation */}
  <nav class={`
    invisible
    absolute
    top-full
    right-0
    left-0
    z-50
    flex
    h-[calc(100dvh-var(--header-height))]
    flex-col
    items-center
    justify-items-start
    space-y-4
    overflow-y-auto
    rounded-4xl
    bg-nav-mobile-bg
    px-8
    py-8
    opacity-0
    transition-[visibility,opacity,border-radius]
    duration-300
    peer-checked:visible
    peer-checked:rounded-none
    peer-checked:opacity-100
    lg:visible
    lg:static
    lg:h-auto
    lg:flex-row
    lg:space-y-0
    lg:space-x-10
    lg:overflow-y-hidden
    lg:bg-transparent
    lg:px-5
    lg:py-0
    lg:opacity-100
  `}>
    {menuItems.map((item) => (
      <div
        class:list={[
          `
            group
            flex
            w-full
            flex-col
            gap-4
            lg:w-auto
            lg:overflow-hidden
          `,
          item.hideOnDesktop && 'lg:hidden'
        ]}
      >
        <button
          class={`
            inline-flex
            cursor-pointer
            items-center
            justify-between
            gap-1.5
            rounded-full
            text-xl
            font-medium
            text-foreground
            transition-colors
            focus-visible:outline-none
            lg:px-3
            lg:py-2
            lg:text-sm
            lg:hover:bg-foreground/10
            lg:focus:bg-foreground/15
          `}
          type="button"
          data-menu-toggle
        >
          {item.label}
          <img
            src="/img/plus.svg"
            alt=""
            aria-hidden="true"
            width="14"
            height="14"
            class={`
              size-3.5
              text-foreground
              transition-transform
              group-focus-within:rotate-45
              lg:size-2.5
            `}
          />
        </button>
        <Menu>
          {item.networkIsland && (
            <NetworkGridIsland variant={item.networkIsland} server:defer>
              <div slot="fallback" class:list={[
                `
                  h-full
                  rounded-lg
                  lg:min-w-[220px]
                  lg:bg-surface
                  lg:p-6
                `,
                item.networkIsland === 'rpc' && 'lg:col-span-2'
              ]}>
                <div class={`
                  mb-2
                  h-3
                  w-24
                  animate-pulse
                  rounded
                  bg-muted/20
                  lg:mb-4
                `} />
                <div class:list={[
                  `
                    flex
                    flex-wrap
                    gap-1.5
                    lg:grid
                    lg:gap-2
                  `,
                  item.networkIsland === 'investment' ? 'lg:grid-cols-2' : `
                    lg:grid-cols-4
                  `
                ]}>
                  {Array.from({ length: item.networkIsland === 'investment' ? 8 : 12 }).map(() => (
                    <div class={`
                      flex
                      items-center
                      gap-2
                      lg:rounded-full
                      lg:border
                      lg:border-separator
                      lg:bg-background
                      lg:p-1.5
                      lg:pr-3
                    `}>
                      <div class={`
                        size-(--icon-size-mobile)
                        shrink-0
                        animate-pulse
                        rounded-[4px]
                        bg-muted/20
                        lg:size-5.5
                        lg:rounded-full
                      `} />
                      <div class={`
                        hidden
                        h-3
                        w-16
                        animate-pulse
                        rounded
                        bg-muted/20
                        lg:block
                      `} />
                    </div>
                  ))}
                </div>
              </div>
            </NetworkGridIsland>
          )}
          {item.sections.map((section) => (
            <MenuSection {...section} />
          ))}
        </Menu>
      </div>
    ))}

    {/* Contact Us Button */}
    <a
      href={getRelativeLocaleUrl(lang, '/contact')}
      class={`
        lg:transition-duration-300
        lg:absolute
        lg:right-(--header-padding)
        lg:mt-0
        lg:h-[calc(var(--header-height)-2*var(--header-padding))]
        lg:w-auto
        lg:rounded-lg
        lg:py-2.5
        lg:text-sm
        lg:transition-[border-radius]
        mt-auto
        w-full
        cursor-pointer
        rounded-xl
        bg-primary
        px-8
        py-3
        text-center
        text-base
        font-medium
        whitespace-nowrap
        text-primary-foreground
        transition-transform
        lg:hover:rounded-sm
        lg:active:scale-98
      `}
    >
      {t('common.contactUs')}
    </a>
  </nav>

  {/* Mobile Hamburger Toggle Label */}
  <label
    for="mobile-menu-toggle"
    aria-label={t('nav.mobileMenuToggle')}
    class={`
      absolute
      right-5
      z-60
      flex
      h-10
      w-10
      cursor-pointer
      flex-col
      items-center
      justify-center
      gap-1.5
      rounded-lg
      transition-colors
      lg:hidden
    `}
  >
    <span class={`
      block
      h-0.5
      w-5
      origin-center
      bg-foreground
      transition-[translate,rotate,background-color]
      duration-300
      group-has-[#mobile-menu-toggle:checked]/menu:translate-y-1
      group-has-[#mobile-menu-toggle:checked]/menu:rotate-45
    `} />
    <span class={`
      block
      h-0.5
      w-5
      origin-center
      bg-foreground
      transition-[translate,rotate,background-color]
      duration-300
      group-has-[#mobile-menu-toggle:checked]/menu:-translate-y-1
      group-has-[#mobile-menu-toggle:checked]/menu:-rotate-45
    `} />
  </label>
</header>

<script>
  document.querySelectorAll<HTMLButtonElement>('[data-menu-toggle]').forEach((btn) => {
    btn.addEventListener('mousedown', (e) => {
      e.preventDefault();
      if (document.activeElement === btn) {
        btn.blur();
      } else {
        btn.focus();
        if (window.innerWidth < 1024) {
          setTimeout(() => {
            btn.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 300);
        }
      }
    });
  });
</script>
