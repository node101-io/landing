---
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import { networks, type NetworkData } from '@/data/networks';
import { Image } from 'astro:assets';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const bySymbol: Record<string, NetworkData> = Object.fromEntries(
  networks.map(n => [n.symbol, n])
);

type CardType = 'featured' | 'tall' | 'medium' | 'small' | 'cta';
type Vis = 'shared' | 'desktop' | 'mobile';

interface GridItem {
  type: CardType;
  vis: Vis;
  grid: string;
  network?: NetworkData;
}

// 12-col desktop (4 rows, 18 cells), 4-col mobile (6 rows, 11 cells)
const items: GridItem[] = [
  // === Shared (mobile + desktop) ===
  { vis: 'shared', type: 'featured', network: bySymbol['ETH'],
    grid: 'col-[3/5] row-[1/3] lg:col-[4/7] lg:row-[1/3]' },
  { vis: 'shared', type: 'tall', network: bySymbol['BTC'],
    grid: 'col-[1/3] row-[1/3] lg:col-[7/9] lg:row-[1/3]' },
  { vis: 'shared', type: 'small', network: bySymbol['BAND'],
    grid: 'col-[2/3] row-[6/7] lg:col-[9/10] lg:row-[1/2]' },
  { vis: 'shared', type: 'medium', network: bySymbol['SOL'],
    grid: 'col-[3/5] row-[3/4] lg:col-[10/13] lg:row-[1/2]' },
  { vis: 'shared', type: 'small', network: bySymbol['AVAX'],
    grid: 'col-[1/2] row-[6/7] lg:col-[9/10] lg:row-[2/3]' },
  { vis: 'shared', type: 'medium', network: bySymbol['WAL'],
    grid: 'col-[1/3] row-[4/5] lg:col-[1/4] lg:row-[3/4]' },
  { vis: 'shared', type: 'medium', network: bySymbol['TIA'],
    grid: 'col-[3/5] row-[4/5] lg:col-[4/7] lg:row-[3/4]' },
  { vis: 'shared', type: 'medium', network: bySymbol['STRK'],
    grid: 'col-[1/3] row-[5/6] lg:col-[7/10] lg:row-[3/4]' },
  { vis: 'shared', type: 'medium', network: bySymbol['ATOM'],
    grid: 'col-[3/5] row-[5/6] lg:col-[10/13] lg:row-[3/4]' },
  { vis: 'shared', type: 'cta',
    grid: 'col-[3/5] row-[6/7] lg:col-[11/13] lg:row-[4/5]' },

  // === Mobile-only ===
  { vis: 'mobile', type: 'medium', network: bySymbol['SUI'],
    grid: 'col-[1/3] row-[3/4]' },

  // === Desktop-only ===
  { vis: 'desktop', type: 'featured', network: bySymbol['SUI'],
    grid: 'col-[1/4] row-[1/3]' },
  { vis: 'desktop', type: 'medium', network: bySymbol['STRK'],
    grid: 'col-[10/13] row-[2/3]' },
  { vis: 'desktop', type: 'medium', network: bySymbol['SOL'],
    grid: 'col-[1/4] row-[4/5]' },
  { vis: 'desktop', type: 'medium', network: bySymbol['TIA'],
    grid: 'col-[4/7] row-[4/5]' },
  { vis: 'desktop', type: 'small', network: bySymbol['ATOM'],
    grid: 'col-[7/8] row-[4/5]' },
  { vis: 'desktop', type: 'small', network: bySymbol['ETH'],
    grid: 'col-[8/9] row-[4/5]' },
  { vis: 'desktop', type: 'small', network: bySymbol['WAL'],
    grid: 'col-[9/10] row-[4/5]' },
  { vis: 'desktop', type: 'small', network: bySymbol['SUI'],
    grid: 'col-[10/11] row-[4/5]' },
];

function getDisplay(vis: Vis) {
  if (vis === 'desktop') return 'hidden lg:flex';
  if (vis === 'mobile') return 'flex lg:hidden';
  return 'flex';
}

const featureColors: Record<string, string> = {
  rpc: '#D9DBFC',
  staking: '#D3EDFF',
};

function renderFeatureTags(features: NetworkData['features']) {
  const tags = features.map(f =>
    `<div class="flex size-[4vw] items-center justify-center rounded-full lg:size-[1.5vw] aspect-square" style="background:${featureColors[f]}">
      <img src="/img/network-feature.svg" alt="${f}" class="size-[2.2vw] lg:size-[0.8vw]" />
    </div>`
  ).join('');
  return `<div class="flex gap-[0.5vw]">${tags}</div>`;
}

const cellStyle = 'bg-gray-50 border border-lav-border';
const imgStyle = 'aspect-square object-contain rounded-[1vw]';

/* ── Cell image class per type ─────────────────────────────── */
const imgClass: Record<string, string> = {
  featured: `w-[35%] h-fit shrink-0 ${imgStyle}`,
  tall:     `w-[calc(50%-2.1vw)] h-fit ${imgStyle}`,
  small:    `size-full ${imgStyle}`,
  medium:   `h-[3.686vw] w-auto ${imgStyle}`,
};
---

<section
  class={`
    m-(--section-margin)
    flex
    w-[calc(100%-var(--section-margin)*2)]
    flex-col
    gap-8
    bg-background
    py-12
    sm:py-16
    md:py-20
    lg:gap-12
    lg:py-24
  `}
  aria-label={t('networks.ariaLabel')}
>
  <!-- Title section -->
  <div class={`
    flex
    flex-col
    gap-8
    lg:flex-row
    lg:items-center
    lg:justify-between
    lg:gap-16
    font-sans
  `}>
    <h2 class={`
      font-display
      text-5xl
      font-bold
      leading-[0.85]
      text-balance
      text-espresso
      md:text-6xl
      lg:w-[60%]
      lg:text-7xl
    `}>
      {t('networks.title')}
    </h2>

    <div class={`
      flex
      flex-col
      gap-6
      lg:w-[40%]
      lg:items-start
    `}>
      <p class={`
        text-xs
        leading-relaxed
        text-espresso
        sm:text-sm
        md:text-base
      `}>
        {t('networks.description')}
      </p>

      <a
        href="#"
        class={`
          inline-flex
          w-fit
          items-center
          justify-center
          rounded-full
          bg-espresso
          px-5
          py-2
          text-sm
          text-cream
          transition-colors
          hover:bg-espresso/90
        `}
      >
        {t('networks.cta')}
      </a>
    </div>
  </div>

  <!-- Networks Grid -->
  <div class={`
    grid
    grid-cols-4
    gap-[4vw]
    lg:grid-cols-12
    lg:grid-rows-4
    lg:gap-[1.4vw]
    lg:aspect-[3.09/1]
  `}>
    {items.map((item) => {
      const n = item.network;
      return (
        <div
          class:list={[
            item.grid,
            getDisplay(item.vis),
            cellStyle,
            'min-h-0 overflow-hidden rounded-[2vw] p-[4vw] lg:p-[1.4vw] font-sans',
          ]}
        >
          {/* ── Featured ── */}
          {item.type === 'featured' && n && (
            <div class="flex flex-col justify-between">
              <div class="flex gap-[1.4vw]">
                <Image src={n.logo} alt={n.name} class={imgClass.featured} />
                <div class="flex flex-col gap-[0.4vw]">
                  <span class="text-[3vw] uppercase leading-relaxed text-espresso-dark lg:text-[1.3vw]">
                    {n.name}
                  </span>
                  <p class="text-[2.5vw] leading-tight text-footnote lg:text-[0.9vw]">
                    {t(n.descriptionKey)}
                  </p>
                </div>
              </div>
              <div set:html={renderFeatureTags(n.features)} class="flex justify-end" />
              <div class="flex items-end justify-between text-[3vw] lg:text-[1.3vw] leading-tight">
                <span class="uppercase text-espresso-dark">{n.symbol}</span>
                <span class="text-footnote">APR {n.apr}%</span>
              </div>
            </div>
          )}

          {/* ── Tall ── */}
          {item.type === 'tall' && n && (
            <div class="flex h-full flex-col justify-between">
              <div class="flex gap-[1.4vw]">
                <Image src={n.logo} alt={n.name} class={imgClass.tall} />
                <div class="flex flex-col">
                  <span class="text-[3vw] uppercase leading-relaxed text-espresso-dark lg:text-[1.3vw]">
                    {n.name}
                  </span>
                  <span class="text-[2.8vw] uppercase leading-tight text-footnote lg:text-[0.9vw]">
                    {n.symbol}
                  </span>
                </div>
              </div>
              <p class="text-[2.5vw] leading-tight text-footnote lg:text-[0.9vw]">
                {t(n.descriptionKey)}
              </p>
              <div class="flex items-end justify-between text-[3vw] lg:text-[1.3vw] leading-tight">
                <span class="text-footnote">APR {n.apr}%</span>
                <div set:html={renderFeatureTags(n.features)} />
              </div>
            </div>
          )}
          {item.type === 'small' && n && (
            <Image src={n.logo} alt={n.name} class={imgClass.small} />
          )}
          {item.type === 'medium' && n && (
            <div class="flex h-full items-center gap-[0.8vw] w-full">
              <Image src={n.logo} alt={n.name} class={imgClass.medium} />
              <div class="flex flex-col">
                <div class="flex items-baseline gap-[0.4vw]">
                  <span class="text-[3vw] uppercase leading-relaxed text-espresso-dark lg:text-[1.3vw]">
                    {n.name}
                  </span>
                  <span class="text-[2.5vw] uppercase leading-tight text-footnote lg:text-[0.9vw]">
                    {n.symbol}
                  </span>
                </div>
                <span class="text-[2.5vw] leading-tight text-footnote lg:text-[0.9vw]">
                  APR {n.apr}%
                </span>
              </div>
              <div set:html={renderFeatureTags(n.features)} class="ml-auto" />
            </div>
          )}
        </div>
      );
    })}
  </div>
</section>
