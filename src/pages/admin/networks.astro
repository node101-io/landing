---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { R2_PUBLIC_URL } from "@/data/r2";
import {
  type KVNetwork,
  type NetworkFeature,
  type NetworkCategories,
  getNetworks,
  putNetworks,
  getNetworkCategories,
  putNetworkCategories,
  removeFromCategories,
  CATEGORY_DEFS,
  EMPTY_CATEGORIES,
} from "@/data/networks";
import slugify from "@sindresorhus/slugify";

export const prerender = false;

const KV = Astro.locals.runtime?.env?.KV;
const R2 = Astro.locals.runtime?.env?.R2;
let message = "";

// Handle POST actions
if (Astro.request.method === "POST" && KV) {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get("_action") as string;

    if (action === "delete") {
      const deleteId = formData.get("id") as string;
      if (deleteId) {
        const existing = await getNetworks(KV);
        const target = existing.find((n) => n.id === deleteId);
        const updated = existing.filter((n) => n.id !== deleteId);
        await putNetworks(KV, updated);

        // Delete logo from R2
        if (target?.logoKey && R2) {
          try {
            await R2.delete(`networks/${target.logoKey}`);
          } catch {
            // logo may not exist in R2
          }
        }

        // Clean up category references
        const cats = await getNetworkCategories(KV);
        if (removeFromCategories(cats, deleteId)) {
          await putNetworkCategories(KV, cats);
        }

        message = `Network "${deleteId}" deleted.`;
      }
    } else if (action === "save") {
      const name = (formData.get("name") as string)?.trim();
      const rawId = (formData.get("id") as string)?.trim();
      const id = rawId || slugify(name ?? "", { locale: "tr" });
      const symbol = (formData.get("symbol") as string)?.trim().toUpperCase();
      const descTr = (formData.get("desc_tr") as string)?.trim();
      const descEn = (formData.get("desc_en") as string)?.trim();
      const href = (formData.get("href") as string)?.trim();
      const apr = parseFloat(formData.get("apr") as string) || 0;
      const features: NetworkFeature[] = [];
      if (formData.get("feature_rpc")) features.push("rpc");
      if (formData.get("feature_staking")) features.push("staking");
      const logoFile = formData.get("logo") as File | null;

      if (!id || !name || !symbol) {
        message = "Error: id, name, and symbol are required.";
      } else {
        const existing = await getNetworks(KV);
        const existingIndex = existing.findIndex((n) => n.id === id);

        // Determine logo key
        let logoKey = `${id}.webp`;
        if (existingIndex >= 0 && existing[existingIndex].logoKey) {
          logoKey = existing[existingIndex].logoKey;
        }

        // Upload logo to R2 if provided
        if (logoFile && logoFile.size > 0 && R2) {
          const ext = logoFile.name.split(".").pop() || "webp";
          logoKey = `${id}.${ext}`;
          const arrayBuffer = await logoFile.arrayBuffer();
          await R2.put(`networks/${logoKey}`, arrayBuffer, {
            httpMetadata: { contentType: logoFile.type },
          });
        }

        const network: KVNetwork = {
          id,
          name,
          symbol,
          description: { tr: descTr || "", en: descEn || "" },
          href: href || `/networks/${id}`,
          apr,
          features,
          logoKey,
        };

        if (existingIndex >= 0) {
          existing[existingIndex] = network;
        } else {
          existing.push(network);
        }

        await putNetworks(KV, existing);
        message =
          existingIndex >= 0
            ? `Network "${name}" updated.`
            : `Network "${name}" added.`;
      }
    } else if (action === "save-categories") {
      const categories: NetworkCategories = { ...EMPTY_CATEGORIES };
      for (const def of CATEGORY_DEFS) {
        const raw = formData.get(`cat_${def.key}`) as string | null;
        if (raw) {
          try {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) categories[def.key] = parsed;
          } catch {
            // invalid JSON â€” keep empty
          }
        }
      }
      await putNetworkCategories(KV, categories);
      message = "Categories saved.";
    }
  } catch (e) {
    message = `Error: ${e instanceof Error ? e.message : "Unknown error"}`;
  }
}

// Read current networks from KV
let networksList: KVNetwork[] = [];
let currentCategories: NetworkCategories = { ...EMPTY_CATEGORIES };
if (KV) {
  try {
    networksList = await getNetworks(KV);
  } catch {
    // fallback to empty
  }
  try {
    currentCategories = await getNetworkCategories(KV);
  } catch {
    // fallback to empty
  }
}

const inputClass =
  "w-full rounded-lg border border-espresso/20 bg-white px-3 py-2 text-sm outline-none focus:border-espresso/40";
const labelClass = "block text-sm font-medium text-espresso/80 mb-1";
---

<AdminLayout title="Networks">
  <h1
    class={`
    mb-6
    text-3xl
    font-bold
  `}
  >
    Networks Management
  </h1>

  {
    message && (
      <div
        class:list={[
          `
        mb-6
        rounded-lg
        border
        px-4
        py-3
        text-sm
      `,
          message.startsWith("Error")
            ? `
          border-red-200
          bg-red-50
          text-red-800
        `
            : `
          border-green-200
          bg-green-50
          text-green-800
        `,
        ]}
      >
        {message}
      </div>
    )
  }

  <div
    class={`
    mb-8
    overflow-x-auto
    rounded-xl
    border
    border-espresso/10
  `}
  >
    <table
      class={`
      w-full
      text-left
      text-sm
    `}
    >
      <thead
        class={`
        border-b
        border-espresso/10
        bg-espresso/5
      `}
      >
        <tr>
          <th
            class={`
            px-4
            py-3
            font-medium
          `}>Logo</th
          >
          <th
            class={`
            px-4
            py-3
            font-medium
          `}>ID</th
          >
          <th
            class={`
            px-4
            py-3
            font-medium
          `}>Name</th
          >
          <th
            class={`
            px-4
            py-3
            font-medium
          `}>Symbol</th
          >
          <th
            class={`
            px-4
            py-3
            font-medium
          `}>APR</th
          >
          <th
            class={`
            px-4
            py-3
            font-medium
          `}>Features</th
          >
          <th
            class={`
            px-4
            py-3
            font-medium
          `}>Actions</th
          >
        </tr>
      </thead>
      <tbody>
        {
          networksList.length === 0 ? (
            <tr>
              <td
                colspan="7"
                class={`
              px-4
              py-8
              text-center
              text-espresso/40
            `}
              >
                No networks in KV. Add one below or they will fall back to
                static data.
              </td>
            </tr>
          ) : (
            networksList.map((network) => (
              <tr
                class={`
              border-b
              border-espresso/5
              last:border-0
            `}
              >
                <td
                  class={`
                px-4
                py-3
              `}
                >
                  {network.logoKey && (
                    <img
                      src={`${R2_PUBLIC_URL}/networks/${network.logoKey}`}
                      alt={network.name}
                      class={`
                      size-8
                      rounded
                      object-contain
                    `}
                      onerror="this.style.display='none'"
                    />
                  )}
                </td>
                <td
                  class={`
                px-4
                py-3
                font-mono
                text-xs
              `}
                >
                  {network.id}
                </td>
                <td
                  class={`
                px-4
                py-3
              `}
                >
                  {network.name}
                </td>
                <td
                  class={`
                px-4
                py-3
                font-mono
              `}
                >
                  {network.symbol}
                </td>
                <td
                  class={`
                px-4
                py-3
              `}
                >
                  {network.apr}%
                </td>
                <td
                  class={`
                px-4
                py-3
              `}
                >
                  <div
                    class={`
                  flex
                  gap-1
                `}
                  >
                    {network.features.map((f) => (
                      <span
                        class:list={[
                          `
                        rounded-full
                        px-2
                        py-0.5
                        text-xs
                      `,
                          f === "rpc" ? "bg-lavender" : "bg-ice-blue",
                        ]}
                      >
                        {f}
                      </span>
                    ))}
                  </div>
                </td>
                <td
                  class={`
                px-4
                py-3
              `}
                >
                  <div
                    class={`
                  flex
                  gap-2
                `}
                  >
                    <button
                      type="button"
                      class={`
                      text-xs
                      text-espresso/60
                      hover:text-espresso
                      hover:underline
                    `}
                      data-edit-network={JSON.stringify(network)}
                    >
                      Edit
                    </button>
                    <form
                      method="POST"
                      class="inline"
                      onsubmit="return confirm('Delete this network?')"
                    >
                      <input type="hidden" name="_action" value="delete" />
                      <input type="hidden" name="id" value={network.id} />
                      <button
                        type="submit"
                        class={`
                      text-xs
                      text-red-600/60
                      hover:text-red-600
                      hover:underline
                    `}
                      >
                        Delete
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            ))
          )
        }
      </tbody>
    </table>
  </div>

  <!-- Header Menu Categories -->
  <div
    class={`
    mb-8
    rounded-xl
    border
    border-espresso/10
    p-6
  `}
  >
    <h2
      class={`
      mb-1
      text-lg
      font-semibold
    `}
    >
      Header Menu Categories
    </h2>
    <p
      class={`
      mb-4
      text-xs
      text-espresso/60
    `}
    >
      Assign networks to header menu categories and control display order. A
      network can appear in multiple categories.
    </p>

    <form method="POST" id="categories-form">
      <input type="hidden" name="_action" value="save-categories" />

      <div
        class={`
        grid
        gap-4
        sm:grid-cols-2
        lg:grid-cols-4
      `}
      >
        {
          CATEGORY_DEFS.map((def) => (
            <div
              class={`
            flex
            flex-col
          `}
              data-category-col={def.key}
            >
              <h3
                class={`
              mb-2
              text-sm
              font-medium
              text-espresso/80
            `}
              >
                {def.label}
              </h3>
              <input
                type="hidden"
                name={`cat_${def.key}`}
                value={JSON.stringify(currentCategories[def.key])}
                data-category-input={def.key}
              />
              <div
                class={`
                mb-2
                min-h-[60px]
                rounded-lg
                border
                border-espresso/10
                bg-espresso/[0.02]
                p-2
              `}
                data-category-list={def.key}
              >
                {/* JS renders ordered list here */}
              </div>
              <div
                class={`
              flex
              gap-1
            `}
              >
                <select
                  class={`
                  flex-1
                  rounded-lg
                  border
                  border-espresso/20
                  bg-white
                  px-2
                  py-1.5
                  text-xs
                  outline-none
                  focus:border-espresso/40
                `}
                  data-category-select={def.key}
                >
                  <option value="">Select network...</option>
                </select>
                <button
                  type="button"
                  class={`
                  rounded-lg
                  bg-espresso/10
                  px-2
                  py-1.5
                  text-xs
                  text-espresso
                  transition-colors
                  hover:bg-espresso/20
                `}
                  data-category-add={def.key}
                >
                  + Add
                </button>
              </div>
            </div>
          ))
        }
      </div>

      <div class="mt-4">
        <button
          type="submit"
          class={`
            rounded-lg
            bg-espresso
            px-4
            py-2
            text-sm
            text-cream
            transition-colors
            hover:bg-espresso/90
          `}
        >
          Save Categories
        </button>
      </div>
    </form>
  </div>

  <div
    id="networks-data"
    hidden
    data-value={JSON.stringify(
      networksList.map((n) => ({ id: n.id, name: n.name, symbol: n.symbol })),
    )}
  >
  </div>

  <!-- Add / Edit Form -->
  <div
    class={`
    rounded-xl
    border
    border-espresso/10
    p-6
  `}
  >
    <h2
      class={`
      mb-4
      text-lg
      font-semibold
    `}
      id="form-title"
    >
      Add Network
    </h2>

    <form method="POST" enctype="multipart/form-data" id="network-form">
      <input type="hidden" name="_action" value="save" />
      <input type="hidden" name="id" />

      <div
        class={`
        grid
        gap-4
        sm:grid-cols-2
        lg:grid-cols-3
      `}
      >
        <div>
          <label for="net-name" class={labelClass}>Name</label>
          <input
            id="net-name"
            type="text"
            name="name"
            class={inputClass}
            required
            placeholder="Ethereum"
          />
        </div>
        <div>
          <label for="net-symbol" class={labelClass}>Symbol</label>
          <input
            id="net-symbol"
            type="text"
            name="symbol"
            class={inputClass}
            required
            placeholder="ETH"
          />
        </div>
        <div>
          <label for="net-href" class={labelClass}>Link (href)</label>
          <input
            id="net-href"
            type="text"
            name="href"
            class={inputClass}
            placeholder="/networks/ethereum"
          />
        </div>
        <div>
          <label for="net-apr" class={labelClass}>APR (%)</label>
          <input
            id="net-apr"
            type="number"
            name="apr"
            step="0.1"
            class={inputClass}
            placeholder="3.2"
          />
        </div>
        <div>
          <label for="net-logo" class={labelClass}>Logo (image file)</label>
          <input
            id="net-logo"
            type="file"
            name="logo"
            accept="image/*"
            class={inputClass}
          />
        </div>
      </div>

      <div
        class={`
        mt-4
        grid
        gap-4
        sm:grid-cols-2
      `}
      >
        <div>
          <label for="net-desc-tr" class={labelClass}>Description (TR)</label>
          <textarea id="net-desc-tr" name="desc_tr" rows="2" class={inputClass}
          ></textarea>
        </div>
        <div>
          <label for="net-desc-en" class={labelClass}>Description (EN)</label>
          <textarea id="net-desc-en" name="desc_en" rows="2" class={inputClass}
          ></textarea>
        </div>
      </div>

      <div class="mt-4">
        <span class={labelClass}>Features</span>
        <div
          class={`
          flex
          gap-4
        `}
        >
          <label
            class={`
            flex
            items-center
            gap-2
            text-sm
          `}
          >
            <input type="checkbox" name="feature_rpc" value="1" />
            RPC
          </label>
          <label
            class={`
            flex
            items-center
            gap-2
            text-sm
          `}
          >
            <input type="checkbox" name="feature_staking" value="1" />
            Staking
          </label>
        </div>
      </div>

      <div
        class={`
        mt-6
        flex
        gap-3
      `}
      >
        <button
          type="submit"
          class={`
            rounded-lg
            bg-espresso
            px-4
            py-2
            text-sm
            text-cream
            transition-colors
            hover:bg-espresso/90
          `}
        >
          Save Network
        </button>
        <button
          type="button"
          id="reset-form"
          class={`
            rounded-lg
            border
            border-espresso/20
            px-4
            py-2
            text-sm
            text-espresso/60
            transition-colors
            hover:bg-espresso/5
          `}
        >
          Reset
        </button>
      </div>
    </form>
  </div>
</AdminLayout>

<script>
  function initNetworkAdmin() {
    const form = document.getElementById(
      "network-form",
    ) as HTMLFormElement | null;
    const formTitle = document.getElementById("form-title");
    const resetBtn = document.getElementById("reset-form");
    const editButtons = document.querySelectorAll("[data-edit-network]");

    if (!form) return;

    const idInput = form.querySelector('[name="id"]') as HTMLInputElement;

    const resetForm = () => {
      form.reset();
      if (formTitle) formTitle.textContent = "Add Network";
      if (idInput) idInput.value = "";
    };

    resetBtn?.addEventListener("click", resetForm);

    editButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        try {
          const network = JSON.parse(
            btn.getAttribute("data-edit-network") || "{}",
          );

          const setVal = (name: string, value: string) => {
            const input = form.querySelector(`[name="${name}"]`) as
              | HTMLInputElement
              | HTMLTextAreaElement
              | null;
            if (input) input.value = value;
          };

          const setChecked = (name: string, checked: boolean) => {
            const input = form.querySelector(
              `[name="${name}"]`,
            ) as HTMLInputElement | null;
            if (input) input.checked = checked;
          };

          setVal("id", network.id || "");
          setVal("name", network.name || "");
          setVal("symbol", network.symbol || "");
          setVal("href", network.href || "");
          setVal("apr", String(network.apr ?? ""));
          setVal("desc_tr", network.description?.tr || "");
          setVal("desc_en", network.description?.en || "");
          setChecked("feature_rpc", network.features?.includes("rpc") || false);
          setChecked(
            "feature_staking",
            network.features?.includes("staking") || false,
          );

          if (formTitle) formTitle.textContent = `Edit: ${network.name}`;

          form.scrollIntoView({ behavior: "smooth" });
        } catch {
          // ignore parse errors
        }
      });
    });
  }

  function initCategoryManager() {
    const dataEl = document.getElementById("networks-data");
    if (!dataEl) return;

    let allNetworks: { id: string; name: string; symbol: string }[] = [];
    try {
      allNetworks = JSON.parse(dataEl.getAttribute("data-value") || "[]");
    } catch {
      return;
    }

    const networkMap = new Map(allNetworks.map((n) => [n.id, n]));

    // Read initial state from hidden inputs
    const state: Record<string, string[]> = {};
    const inputs = document.querySelectorAll(
      "[data-category-input]",
    ) as NodeListOf<HTMLInputElement>;
    inputs.forEach((input) => {
      const key = input.getAttribute("data-category-input")!;
      try {
        state[key] = JSON.parse(input.value || "[]");
      } catch {
        state[key] = [];
      }
    });

    function renderCategory(key: string) {
      const listEl = document.querySelector(`[data-category-list="${key}"]`);
      const inputEl = document.querySelector(
        `[data-category-input="${key}"]`,
      ) as HTMLInputElement | null;
      const selectEl = document.querySelector(
        `[data-category-select="${key}"]`,
      ) as HTMLSelectElement | null;
      if (!listEl || !inputEl || !selectEl) return;

      const ids = state[key] || [];

      // Sync hidden input
      inputEl.value = JSON.stringify(ids);

      // Render ordered list
      listEl.innerHTML = "";
      if (ids.length === 0) {
        const empty = document.createElement("p");
        empty.className = "text-xs text-espresso/30 italic px-1 py-2";
        empty.textContent = "No networks assigned";
        listEl.appendChild(empty);
      } else {
        ids.forEach((id, idx) => {
          const net = networkMap.get(id);
          const row = document.createElement("div");
          row.className =
            "flex items-center gap-1 rounded px-1 py-0.5 text-xs hover:bg-espresso/5";

          const label = document.createElement("span");
          label.className = "flex-1 truncate";
          label.textContent = `${idx + 1}. ${net ? `${net.name} (${net.symbol})` : id}`;
          row.appendChild(label);

          const btnClass =
            "px-1 py-0.5 text-[10px] rounded hover:bg-espresso/10 text-espresso/50 hover:text-espresso";

          if (idx > 0) {
            const upBtn = document.createElement("button");
            upBtn.type = "button";
            upBtn.className = btnClass;
            upBtn.textContent = "\u2191";
            upBtn.dataset.action = "up";
            upBtn.dataset.catKey = key;
            upBtn.dataset.idx = String(idx);
            row.appendChild(upBtn);
          }

          if (idx < ids.length - 1) {
            const downBtn = document.createElement("button");
            downBtn.type = "button";
            downBtn.className = btnClass;
            downBtn.textContent = "\u2193";
            downBtn.dataset.action = "down";
            downBtn.dataset.catKey = key;
            downBtn.dataset.idx = String(idx);
            row.appendChild(downBtn);
          }

          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className =
            btnClass + " text-red-500/50 hover:text-red-600";
          removeBtn.textContent = "\u00D7";
          removeBtn.dataset.action = "remove";
          removeBtn.dataset.catKey = key;
          removeBtn.dataset.idx = String(idx);
          row.appendChild(removeBtn);

          listEl.appendChild(row);
        });
      }

      // Update select options (exclude already assigned)
      const assigned = new Set(ids);
      selectEl.innerHTML = '<option value="">Select network...</option>';
      allNetworks.forEach((n) => {
        if (!assigned.has(n.id)) {
          const opt = document.createElement("option");
          opt.value = n.id;
          opt.textContent = `${n.name} (${n.symbol})`;
          selectEl.appendChild(opt);
        }
      });
    }

    // Event delegation on each category column
    document.querySelectorAll("[data-category-col]").forEach((col) => {
      col.addEventListener("click", (e) => {
        const target = e.target as HTMLElement;
        const action = target.dataset.action;
        const catKey = target.dataset.catKey;
        const idx =
          target.dataset.idx != null ? parseInt(target.dataset.idx, 10) : -1;

        if (!action || !catKey || !state[catKey]) return;

        const arr = state[catKey];

        if (action === "up" && idx > 0) {
          [arr[idx - 1], arr[idx]] = [arr[idx], arr[idx - 1]];
          renderCategory(catKey);
        } else if (action === "down" && idx < arr.length - 1) {
          [arr[idx], arr[idx + 1]] = [arr[idx + 1], arr[idx]];
          renderCategory(catKey);
        } else if (action === "remove" && idx >= 0) {
          arr.splice(idx, 1);
          renderCategory(catKey);
        }
      });
    });

    // Add button handlers
    document.querySelectorAll("[data-category-add]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const key = (btn as HTMLElement).dataset.categoryAdd!;
        const selectEl = document.querySelector(
          `[data-category-select="${key}"]`,
        ) as HTMLSelectElement | null;
        if (!selectEl || !selectEl.value) return;

        if (!state[key]) state[key] = [];
        state[key].push(selectEl.value);
        renderCategory(key);
      });
    });

    // Initial render
    Object.keys(state).forEach(renderCategory);
  }

  initNetworkAdmin();
  initCategoryManager();
  document.addEventListener("astro:after-swap", () => {
    initNetworkAdmin();
    initCategoryManager();
  });
</script>
