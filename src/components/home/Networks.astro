---
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import { networks, type NetworkData } from '@/data/networks';
import { Image } from 'astro:assets';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

type CardType = 'rectangle-big' | 'square-big' | 'rectangle-small' | 'square-small' | 'cta';

interface LayoutSlot {
  type: CardType;
  grid: string;
}

interface GridItem {
  type: CardType;
  grid: string;
  display: string;
  network?: NetworkData;
}

// ── Desktop layout (12-col, 4 rows) ──────────────────────────
const desktopLayout: LayoutSlot[] = [
  // Row 1-2 (slots 0-6)
  { type: 'rectangle-big',   grid: 'col-[1/4] row-[1/3]' },
  { type: 'rectangle-big',   grid: 'col-[4/7] row-[1/3]' },
  { type: 'square-big',      grid: 'col-[7/9] row-[1/3]' },
  { type: 'square-small',    grid: 'col-[9/10] row-[1/2]' },
  { type: 'rectangle-small', grid: 'col-[10/13] row-[1/2]' },
  { type: 'square-small',    grid: 'col-[9/10] row-[2/3]' },
  { type: 'rectangle-small', grid: 'col-[10/13] row-[2/3]' },
  // Row 3 (slots 7-10)
  { type: 'rectangle-small', grid: 'col-[1/4] row-[3/4]' },
  { type: 'rectangle-small', grid: 'col-[4/7] row-[3/4]' },
  { type: 'rectangle-small', grid: 'col-[7/10] row-[3/4]' },
  { type: 'rectangle-small', grid: 'col-[10/13] row-[3/4]' },
  // Row 4 (slots 11-17)
  { type: 'rectangle-small', grid: 'col-[1/4] row-[4/5]' },
  { type: 'rectangle-small', grid: 'col-[4/7] row-[4/5]' },
  { type: 'square-small',    grid: 'col-[7/8] row-[4/5]' },
  { type: 'square-small',    grid: 'col-[8/9] row-[4/5]' },
  { type: 'square-small',    grid: 'col-[9/10] row-[4/5]' },
  { type: 'square-small',    grid: 'col-[10/11] row-[4/5]' },
  // CTA
  { type: 'cta',             grid: 'col-[11/13] row-[4/5]' },
];

// ── Mobile layout (4-col, 7 rows) ────────────────────────────
const mobileLayout: LayoutSlot[] = [
  // Row 1-2
  { type: 'square-big',      grid: 'col-[1/3] row-[1/3]' },
  { type: 'square-big',      grid: 'col-[3/5] row-[1/3]' },
  // Row 3
  { type: 'rectangle-small', grid: 'col-[1/3] row-[3/4]' },
  { type: 'rectangle-small', grid: 'col-[3/5] row-[3/4]' },
  // Row 4
  { type: 'rectangle-small', grid: 'col-[1/3] row-[4/5]' },
  { type: 'rectangle-small', grid: 'col-[3/5] row-[4/5]' },
  // Row 5
  { type: 'rectangle-small', grid: 'col-[1/3] row-[5/6]' },
  { type: 'square-small',    grid: 'col-[3/4] row-[5/6]' },
  { type: 'square-small',    grid: 'col-[4/5] row-[5/6]' },
  // Row 6
  { type: 'square-small',    grid: 'col-[1/2] row-[6/7]' },
  { type: 'square-small',    grid: 'col-[2/3] row-[6/7]' },
  { type: 'square-small',    grid: 'col-[3/4] row-[6/7]' },
  { type: 'square-small',    grid: 'col-[4/5] row-[6/7]' },
  // Row 7
  { type: 'cta',             grid: 'col-[1/5] row-[7/8]' },
];

// ── Build items from layout + networks ───────────────────────
function buildItems(layout: LayoutSlot[], display: string): GridItem[] {
  let networkIndex = 0;
  return layout.map((slot) => {
    if (slot.type === 'cta') {
      return { type: slot.type, grid: slot.grid, display };
    }
    const network = networks[networkIndex % networks.length];
    networkIndex++;
    return { type: slot.type, grid: slot.grid, display, network };
  });
}

const desktopItems = buildItems(desktopLayout, 'hidden lg:flex');
const mobileItems = buildItems(mobileLayout, 'flex lg:hidden');
const allItems = [...desktopItems, ...mobileItems];

const featureColors: Record<string, string> = {
  rpc: '#D9DBFC',
  staking: '#D3EDFF',
};

function renderFeatureTags(features: NetworkData['features']) {
  const tags = features.map(f =>
    `<div class="flex size-[4vw] items-center justify-center rounded-full lg:size-[1.5vw] aspect-square" style="background:${featureColors[f]}">
      <img src="/img/network-feature.svg" alt="${f}" class="size-[2.2vw] lg:size-[0.8vw]" />
    </div>`
  ).join('');
  return `<div class="flex gap-[0.5vw]">${tags}</div>`;
}

const cellStyle = 'bg-gray-50 border border-lav-border';
const imgStyle = 'aspect-square object-contain rounded-[4vw] lg:rounded-[1vw]';

const imgClass: Record<string, string> = {
  'rectangle-big':   `w-[35%] h-fit shrink-0 ${imgStyle}`,
  'square-big':      `w-[calc(50%-6vw)] lg:w-[calc(50%-2.1vw)] h-fit ${imgStyle}`,
  'square-small':    `size-full ${imgStyle}`,
  'rectangle-small': `h-[13vw] lg:h-[3.686vw] w-auto ${imgStyle}`,
};
---

<div class={`
  relative
  m-(--section-margin)
  w-[calc(100%-var(--section-margin)*2)]
`}>
  <div class={`
    pointer-events-none
    absolute
    -inset-40
    -z-10
    opacity-60
    bg-[radial-gradient(ellipse_max(70vw,700px)_max(40vw,400px)_at_center,#E5E6FF_0%,#FEF9F3_60%,transparent_100%)]
  `} aria-hidden="true"></div>
  <section
    class={`
      @container
      relative
      isolate
      flex
      flex-col
      gap-8
      overflow-x-clip
      py-12
      sm:py-16
      md:py-20
      lg:gap-12
      lg:py-24
    `}
    aria-label={t('networks.ariaLabel')}
  >
  <!-- Title section -->
  <div class={`
    flex
    flex-col
    gap-8
    font-sans
    lg:flex-row
    lg:items-center
    lg:justify-between
    lg:gap-16
  `}>
    <h2 class={`
      font-display
      text-5xl
      leading-[0.85]
      font-bold
      text-balance
      text-espresso
      md:text-6xl
      lg:w-[60%]
      lg:text-7xl
    `}>
      {t('networks.title')}
    </h2>

    <div class={`
      flex
      flex-col
      gap-6
      lg:w-[40%]
      lg:items-start
    `}>
      <p class={`
        text-xs
        leading-relaxed
        text-espresso
        sm:text-sm
        md:text-base
      `}>
        {t('networks.description')}
      </p>

      <a
        href="#"
        class={`
          inline-flex
          w-fit
          items-center
          justify-center
          rounded-full
          bg-espresso
          px-5
          py-2
          text-sm
          text-cream
          transition-colors
          hover:bg-espresso/90
        `}
      >
        {t('networks.cta')}
      </a>
    </div>
  </div>

  <!-- Networks Grid -->
  <div class={`
    grid
    grid-cols-4
    grid-rows-[repeat(6,calc(25cqi-3vw))_auto]
    gap-[4vw]
    lg:grid-cols-12
    lg:grid-rows-[repeat(4,calc(8.3333cqi-1.2833vw))]
    lg:gap-[1.4vw]
  `}>
    {allItems.map((item) => {
      const n = item.network;
      return (
        <div
          class:list={[
            item.grid,
            item.display,
            cellStyle,
            `
              min-h-0
              overflow-hidden
              rounded-[6vw]
              p-[3vw]
              font-sans
              lg:rounded-[2vw]
              lg:p-[1.4vw]
            `,
            item.type === 'square-big' && `
              aspect-square
              lg:aspect-auto
            `,
            item.type === 'square-small' && `
              items-center
              justify-center
            `,
          ]}
        >
          {/* ── Rectangle Big ── */}
          {item.type === 'rectangle-big' && n && (
            <div class={`
              flex
              flex-col
              justify-between
            `}>
              <div class={`
                flex
                gap-[1.4vw]
              `}>
                <Image src={n.logo} alt={n.name} class={imgClass['rectangle-big']} />
                <div class={`
                  flex
                  flex-col
                  gap-[0.4vw]
                `}>
                  <span class={`
                    text-[3vw]
                    leading-relaxed
                    text-espresso-dark
                    uppercase
                    lg:text-[1.3vw]
                  `}>
                    {n.name}
                  </span>
                  <p class={`
                    text-[2.5vw]
                    leading-tight
                    text-footnote
                    lg:text-[0.9vw]
                  `}>
                    {t(n.descriptionKey)}
                  </p>
                </div>
              </div>
              <div set:html={renderFeatureTags(n.features)} class={`
                flex
                justify-end
              `} />
              <div class={`
                flex
                items-end
                justify-between
                text-[3vw]
                leading-tight
                lg:text-[1.3vw]
              `}>
                <span class={`
                  text-espresso-dark
                  uppercase
                `}>{n.symbol}</span>
                <span class="text-footnote">APR {n.apr}%</span>
              </div>
            </div>
          )}

          {/* ── Square Big ── */}
          {item.type === 'square-big' && n && (
            <div class={`
              flex
              flex-col
              justify-between
            `}>
              <div class={`
                flex
                gap-[1.4vw]
              `}>
                <Image src={n.logo} alt={n.name} class={imgClass['square-big']} />
                <div class={`
                  flex
                  flex-col
                `}>
                  <span class={`
                    text-[3vw]
                    leading-relaxed
                    text-espresso-dark
                    uppercase
                    lg:text-[1.3vw]
                  `}>
                    {n.name}
                  </span>
                  <span class={`
                    text-[2.8vw]
                    leading-tight
                    text-footnote
                    uppercase
                    lg:text-[0.9vw]
                  `}>
                    {n.symbol}
                  </span>
                </div>
              </div>
              <p class={`
                text-[2.5vw]
                leading-tight
                text-footnote
                lg:text-[0.9vw]
              `}>
                {t(n.descriptionKey)}
              </p>
              <div class={`
                flex
                items-end
                justify-between
                text-[3vw]
                leading-tight
                lg:text-[1.3vw]
              `}>
                <span class="text-footnote">APR {n.apr}%</span>
                <div set:html={renderFeatureTags(n.features)} />
              </div>
            </div>
          )}

          {/* ── Square Small ── */}
          {item.type === 'square-small' && n && (
            <Image src={n.logo} alt={n.name} class={imgClass['square-small']} />
          )}

          {/* ── Rectangle Small ── */}
          {item.type === 'rectangle-small' && n && (
            <div class={`
              flex
              h-full
              w-full
              items-center
              gap-[2vw]
              lg:gap-[0.8vw]
            `}>
              <Image src={n.logo} alt={n.name} class={imgClass['rectangle-small']} />
              <div class={`
                flex
                flex-col
              `}>
                <div class={`
                  flex
                  items-baseline
                  gap-[0.4vw]
                `}>
                  <span class={`
                    text-[3vw]
                    leading-relaxed
                    text-espresso-dark
                    uppercase
                    lg:text-[1.3vw]
                  `}>
                    {n.name}
                  </span>
                  <span class={`
                    text-[2.5vw]
                    leading-tight
                    text-footnote
                    uppercase
                    lg:text-[0.9vw]
                  `}>
                    {n.symbol}
                  </span>
                </div>
                <span class={`
                  text-[2.5vw]
                  leading-tight
                  text-footnote
                  lg:text-[0.9vw]
                `}>
                  APR {n.apr}%
                </span>
              </div>
              <div set:html={renderFeatureTags(n.features)} class={`
                ml-auto
                hidden
                lg:flex
              `} />
            </div>
          )}

          {/* ── CTA ── */}
          {item.type === 'cta' && (
            <a
              href="#"
              class={`
                flex
                h-full
                w-full
                items-center
                justify-center
                text-[3vw]
                text-espresso-dark
                underline
                lg:text-[1.3vw]
              `}
            >
              {t('common.allNetworks')}
            </a>
          )}
        </div>
      );
    })}
  </div>
  </section>
</div>
